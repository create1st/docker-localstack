env:
  BUILDKITE_CLEAN_CHECKOUT: true

  INFRA_PATH: 'infrastructure'

  BK_AGENT_GLOBAL: 'global'
steps:
  - label: ":buildkite: Triggering pipelines"
    plugins:
      - chronotc/monorepo-diff#1.3.2:
          diff: ".buildkite/scripts/diff-against-last-built-tag.sh"
          watch:
            - path: infrastructure/terraform/
              config:
                command: "buildkite-agent pipeline upload ${INFRA_PATH}/.buildkite/pipeline.yaml"
                label: ":terraform: Triggered infrastructure update"
                env:
                  - INFRA_PATH
          hooks:
            - command: "echo $(git rev-parse HEAD) > last_successful_build"
    agents:
      queue: ${BK_AGENT_GLOBAL}

#          wait: ~

#            - path: "app/"
#              config:
#                trigger: "deploy-app-service"
#                  label: "Triggered deploy"
#                  build:
#                    message: "Deploying App service"
#                    env:
#                      - HELLO=123
#                      - AWS_REGION
#          wait: true
